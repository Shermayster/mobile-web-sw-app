"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ratingValue,online=navigator.onLine,localIdCounter=0;"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").then(function(){console.log("service worker registered!")}).catch(function(e){console.log(e)});var RestarauntInfo=function(){function e(){_classCallCheck(this,e),this.restaurant=null,this.isTitle=!1}return _createClass(e,[{key:"fetchRestaurantFromURL",value:function(e){var n=this;if(this.restaurant)return new Promise(function(e,t){e(n.restaurant)});var t=this.getParameterByName("id");if(t)return DBHelper.fetchRestaurantById(t).then(function(e){if(n.restaurant=e)return n.fillRestaurantHTML(),e;console.error("restaurant not found")});return new Promise(function(e,t){t("No restaurant id in URL")})}},{key:"fillRestaurantHTML",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.restaurant,t=document.querySelector("#restaraunt-name"),n=document.createElement("h2");n.setAttribute("id","restaurant-name"),n.innerHTML=e.name;var r=this.appendRestaurantImage(e);t.insertAdjacentElement("afterbegin",r),t.insertAdjacentElement("afterbegin",n),document.getElementById("restaurant-address").innerHTML=e.address,document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&this.fillRestaurantHoursHTML(),document.querySelector("#favoriteInput").checked="true"===e.is_favorite}},{key:"initReviews",value:function(){var t=this,e=this.getParameterByName("id");DBHelper.getRestaurantReviews(e).then(function(e){t.fillReviewsHTML(e)})}},{key:"appendRestaurantImage",value:function(e){var t=document.createElement("picture");t.setAttribute("id","restaurant-img");var n=DBHelper.imageUrlForRestaurant(e),r="Restaurant: "+e.name;return ImageHelper.creatSourcesForPicture(n,r).forEach(function(e){return t.append(e)}),t.className="lazyload",t}},{key:"fillRestaurantHoursHTML",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.restaurant.operating_hours,t=document.getElementById("restaurant-hours");for(var n in e)if(n){var r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);var i=document.createElement("td");i.innerHTML=e[n],r.appendChild(i),t.appendChild(r)}}},{key:"fillReviewsHTML",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=document.getElementById("reviews-container");this.appendTitle(t),e.length?this.appendReviewsList(e):this.appendNoReviews(t)}},{key:"appendTitle",value:function(e){if(!this.isTitle){var t=document.createElement("h3");t.innerHTML="Reviews",e.appendChild(t),this.isTitle=!0}}},{key:"appendNoReviews",value:function(e){if(!document.querySelector(".no-review-message")){var t=document.createElement("p");t.classList=["no-review-message"],t.innerHTML="No reviews yet!",e.appendChild(t)}}},{key:"appendReviewsList",value:function(e){var t=this,n=document.getElementById("reviews-container"),r=document.getElementById("reviews-list");this.clearPrevReviews(r),e.forEach(function(e){r.appendChild(t.createReviewHTML(e))}),n.appendChild(r)}},{key:"clearPrevReviews",value:function(e){for(;e.firstChild;)e.firstChild.remove()}},{key:"createReviewHTML",value:function(e){var t=document.createElement("li"),n=e.id?e.id:e.clientId;t.setAttribute("id",n);var r=document.createElement("div");r.className="review-title review-details",t.appendChild(r);var a=document.createElement("p");a.innerHTML=e.name,a.className="reviewer-name",r.appendChild(a);var i=document.createElement("button");i.classList=["delete-btn"],i.onclick=function(){return deleteReview(e)};var o=document.createElement("span");o.innerText="Delete",i.appendChild(o);var c="http://www.w3.org/2000/svg",l=document.createElementNS(c,"svg");l.setAttributeNS(null,"width",20),l.setAttributeNS(null,"height",20),l.setAttributeNS(null,"viewBox","0 0 24 24"),l.setAttributeNS(null,"fill","white");var u=document.createElementNS(c,"path");u.setAttributeNS(null,"d","M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z");var s=document.createElementNS(c,"path");s.setAttributeNS(null,"d","M0 0h24v24H0z"),s.setAttributeNS(null,"fill","none");var d=document.createElementNS(c,"desc");d.innerHTML="Delete review",l.appendChild(d),l.appendChild(u),l.appendChild(s),i.appendChild(l),r.appendChild(i);var m=document.createElement("div");m.className="review-content review-details",t.appendChild(m);var v=document.createElement("p");v.innerHTML="Rating: "+e.rating,v.className="review-rating uppercase",m.appendChild(v);var f=document.createElement("p");return f.innerHTML=e.comments,m.appendChild(f),t}},{key:"fillBreadcrumb",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.restaurant,t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,n.setAttribute("aria-current","page"),t.appendChild(n)}},{key:"getParameterByName",value:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}}]),e}(),restarauntInfo=new RestarauntInfo;restarauntInfo.initReviews(),window.initMap=function(){restarauntInfo.fetchRestaurantFromURL().then(function(e){var t=new google.maps.Map(document.getElementById("map"),{zoom:16,center:e.latlng,scrollwheel:!1});restarauntInfo.fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(restarauntInfo.restaurant,t)})};var accBtn=document.querySelector(".accordion");function setRating(n){document.querySelectorAll(".form-group .rating-label").forEach(function(e,t){e.innerText=n<t+1?"☆":"★"}),ratingValue=n,onFormValueChange()}function getAccordionText(e){return"SHOW MAP"===e?"HIDE MAP":"SHOW MAP"}function toggleFormView(){var e=document.querySelector(".add-review form");e.style.display=e.style.display?"none"===e.style.display?"block":"none":"block",setRating(0)}function submitForm(){var e=getFormData(),t=restarauntInfo.getParameterByName("id");postReview(Object.assign({},{restaurant_id:t},e))}function postReview(e){var n=restarauntInfo.getParameterByName("id"),r=(new Date).toISOString(),a=Object.assign({},{restaurant_id:n,clientId:getClientId()},e);"serviceWorker"in navigator&&"SyncManager"in window?readDataByKey("reviews",n).then(function(e){var t=[].concat(_toConsumableArray(e),[a]);writeData("reviews",t,n).then(function(){console.log("update local reviews",t),restarauntInfo.fillReviewsHTML(t),navigator.serviceWorker.ready.then(function(e){writeData("sync-reviews",Object.assign({},a,{id:r}),r).then(function(){return console.log("review posted"),resetForm(),e.sync.register("post-new-review")}).then(function(){var e=document.querySelector("#toast");toaster.classList=["show"],e.innerText="Your review was saved"}).catch(function(e){console.log(e)})})})}):DBHelper.addReview(a).then(function(e){console.log("res",e),updateUI(e),resetForm()})}function deleteReview(n){var r=restarauntInfo.getParameterByName("id");!n.id&&n.clientId?readDataByKey("reviews",r).then(function(e){var t=e.filter(function(e){return e.clientId!==n.clientId});writeData("reviews",t,r).then(function(){deleteItemFromData("sync-reviews",n.clientId),deleteReviewFromDom(n)})}):"serviceWorker"in navigator&&"SyncManager"in window?readDataByKey("reviews",r).then(function(e){var t=e.filter(function(e){return e.id!==n.id});writeData("reviews",t,r).then(function(){console.log("update local reviews after delete",t),restarauntInfo.fillReviewsHTML(t),navigator.serviceWorker.ready.then(function(e){writeData("sync-deleted-reviews",n,n.id).then(function(){return deleteReviewFromDom(n),e.sync.register("delete-review")})})})}):DBHelper.deleteReview(n.id).then(function(e){deleteReviewFromDom(e)})}function resetForm(){document.querySelector(".add-review form").reset(),setRating(0)}function updateUI(e){document.getElementById("reviews-list").appendChild(restarauntInfo.createReviewHTML(e))}function onFormValueChange(){document.querySelector(".submit button").disabled=!isFormValid()}function isFormValid(){var e=getFormData();return!!(e.name.trim()&&e.comments.trim()&&e.rating)}function resetForm(){toggleFormView()}online?accBtn.addEventListener("click",function(){document.querySelector("#map").classList.toggle("show"),accBtn.classList.toggle("active"),accBtn.innerText=getAccordionText(accBtn.innerText)}):accBtn.style.display="none";var getFormData=function(){return{name:getNameValue(),rating:ratingValue,comments:getCommentsValue()}},getNameValue=function(){return document.querySelector("#name-input").value},getCommentsValue=function(){return document.querySelector("#review-input").value},deleteReviewFromDom=function(t){document.querySelectorAll("#reviews-list li").forEach(function(e){e.id!=t.id&&e.id!==t.clientId||e.remove()})};function getClientId(){var e="clientId"+localIdCounter;return localIdCounter++,e}function onOnline(){var e=document.querySelector("#toast");e.classList=["show"],updateView(),e.innerText="You are online",setTimeout(function(){e.classList=[]},2e3)}function onOffline(){var e=document.querySelector("#toast");e.classList=["show"],e.innerText="You are offline",setTimeout(function(){e.classList=[]},2e3)}function updateView(){console.log("online"),document.querySelector("#toast").innerText="Online",restarauntInfo.fetchRestaurantFromURL().then(function(e){if(navigator.onLine){var t=new google.maps.Map(document.getElementById("map"),{zoom:16,center:e.latlng,scrollwheel:!1});DBHelper.mapMarkerForRestaurant(restarauntInfo.restaurant,t)}restarauntInfo.fillBreadcrumb()})}function onFavoriteClickHandler(n){var r=restarauntInfo.getParameterByName("id");"serviceWorker"in navigator&&"SyncManager"in window?readData("restaurants").then(function(e){var t=e.map(function(e){return e.id===r&&(e.is_favorite=n.target.checked),e});clearAllData("restaurants").then(function(){writeData("restaurants",t,"restaurants").then(function(){navigator.serviceWorker.ready.then(function(e){var t={};t[r]=n.target.checked,writeData("sync-is-favorite",t,r).then(function(){return e.sync.register("is-favorite")})})})})}):DBHelper.manageFavorite(r,n.target.checked).then(function(e){return console.log("favorites",e)})}function onRatingKeyup(e,t){"Space"!==e.code&&32!==e.code||(e.preventDefault(),setRating(t))}window.addEventListener("online",onOnline),window.addEventListener("offline",onOffline),window.addEventListener("keydown",function(e){if(13===e.keyCode||"Enter"===e.keyCode)return e.preventDefault(),!1});